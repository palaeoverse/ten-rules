---
title: "10 Rules vignette"
author: "The Palaeoverse Development Team"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{10 Rules vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\vignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, include = TRUE, eval = TRUE, dpi = 200,
                      out.width = "100%", fig.width = 7.2, fig.height = 4)
```

# Introduction

Here we present a full example workflow that complies with the 10 Rules we propose in the manuscript.

## Load packages

```{r load_packages, message=FALSE}
#install.packages(c("dplyr", "palaeoverse"))
library(dplyr)
library(palaeoverse)
```

## Rule 1: Know your data and question

In this example, we will explore, clean and interrogate the fossil record of crocodiles. As ectotherms, crocodiles are highly reliant on the environment in which they live in order to maintain a functional internal body temperature. Because of this, their spatial distribution is constrained to warm climates, so their fossil record is commonly used as an indicator of palaeoclimate. Here we will investigate the palaeodiversity of crocodiles, with the specific goal of reconstructing their biogeographic patterns throughout the Paleogene. The data will be sourced from the [Paleobiology Database](https://paleobiodb.org).

## Rule 2: Keep raw data raw


The raw download includes a block of metadata at the top, including valuable information such as the URL for the API call, and the date and time of download. We can retain this information in the raw file, but read into R the table beneath it, using the `skip` parameter, which tells R to ignore the given number of rows at the top of the file.

```{r read_raw}
fossils <- read.csv("../data/Paleogene_crocs.csv", header = TRUE, skip = 19)
```

## Rule 3: Document your workflow

## Rule 4: Explore your data
Here is data exploration

```{r load_packages2, message=FALSE}
library(ggplot2)
library(deeptime)
library(rnaturalearth)
library(rnaturalearthdata)
```

First we'll plot where the crocodile fossils have been found across the globe.

```{r map}
world <- ne_countries(scale = "medium", returnclass = "sf")
ggplot(fossils) +
  geom_sf(data = world) +
  geom_point(aes(x = lng, y = lat)) +
  labs(x = "Longitude",
       y = "Latitude") +
  coord_sf()
```

We have a large density of crocodile occurrences in Europe and the western interior of the United States along with a smattering of occurrences across the other continents. The crocodile occurrences in Antarctica seem particularly suspicious. Let's investigate further. We'll plot the latitude of the occurrences through time.

```{r lat_time}
fossils <- fossils %>%
  mutate(mid_age = (min_ma + max_ma) / 2)

ggplot(fossils, aes(x = mid_age, y = lat)) +
  geom_point() +
  labs(x = "Age (Ma)",
       y = "Latitude") +
  scale_x_reverse() +
  coord_geo(dat = "stages", expand = TRUE)
```

When we look at latitude through time, these occurrences look even more suspicious. But, wait, we should actually be looking at **paleo**latitude instead. Let's plot that against time.

```{r paleolat_time}
fossils <- fossils %>%
  mutate(mid_age = (min_ma + max_ma) / 2)

ggplot(fossils, aes(x = mid_age, y = paleolat)) +
  geom_point() +
  labs(x = "Age (Ma)",
       y = "Paleolatitude") +
  scale_x_reverse() +
  coord_geo(dat = "stages", expand = TRUE)
```

Hmm...when we look at paleolatitude the occurrences are even **more** south. Time to really check out these occurrences...

Well, upon further investigation in the Paleobiology Database, the collections that these occurrences come from ([31173](https://paleobiodb.org/classic/basicCollectionSearch?collection_no=31173), [120887](https://paleobiodb.org/classic/basicCollectionSearch?collection_no=120887), and [43030](https://paleobiodb.org/classic/basicCollectionSearch?collection_no=43030)).
 all appear to be fairly legitimate. However, all three occurrences still appear to be outliers, especially in the late Eocene [when temperatures were dropping](https://doi.org/10.1038/s41586-018-0272-2). Since all three occurrences are listed as Crocodylia indet., it may make sense to remove them from further analyses.

Let's investigate if there are any other anomalies or outliers in our data. We'll bin the occurrences by stage to look for stage-level outliers.

```{r lat_time_binned}
bins <- time_bins(scale = "international ages")
fossils <- bin_time(occdf = fossils, bins = bins,
                    min_ma = "min_ma", max_ma = "max_ma", method = "majority") %>%
  left_join(bins, by = c("bin_assignment" = "bin"))

ggplot(fossils, aes(x = mid_ma, y = paleolat, fill = interval_name)) +
  geom_boxplot(scale = "width", show.legend = FALSE) +
  labs(x = "Age (Ma)",
       y = "Paleolatitude") +
  scale_x_reverse() +
  scale_fill_geo("stages") +
  coord_geo(dat = "stages", expand = TRUE)
```

Hmm, the Ypresian is looking pretty suspicious. Let's plot the Ypresian occurrences on a paleogeographic map to investigate further.

```{r map_ypresian}
library(rgplates)
fossils_y <- fossils %>%
  filter(interval_name == "Ypresian")
world_y <- reconstruct("coastlines", age = 51.9)

ggplot(fossils_y) +
  geom_sf(data = world_y) +
  geom_point(aes(x = paleolng, y = paleolat)) +
  labs(x = "Paleolongitude",
       y = "Paleolatitude") +
  coord_sf()
```

Aha! There is a concentrated cluster of occurrences in the western interior of North America. Without this strong geographic bias, all of the occurrences in the Ypresian appear to be normal, especially with [elevated temperatures during this time](https://doi.org/10.1038/s41586-018-0272-2).

```{r lat_ypresian}
library(rgplates)
fossils_y <- fossils_y %>%
  filter(paleolat < 45)

ggplot(fossils_y) +
  geom_histogram(aes(x = paleolat)) +
  labs(x = "Paleolatitude")
```

## Rule 5: Handle incomplete data records

## Rule 6: Identify outliers

## Rule 7: Identify inconsistencies

## Rule 8: Identify duplicates

## Rule 9: Report your data cleaning efforts

"Here is what we would write in the paper"

## Rule 10: Deposit your data workflow and recording

# Summary
